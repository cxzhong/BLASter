name: Build and Test BLASter

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Allow manual triggers

jobs:
  test-build:
    name: Test Build on ${{ matrix.os }} with Python ${{ matrix.python-version }}
    runs-on: ${{ matrix.os }}
    
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.11', '3.12', '3.13']
        exclude:
          # Exclude some combinations to reduce CI time while maintaining good coverage
          - os: macos-latest
            python-version: '3.12'
          - os: windows-latest
            python-version: '3.13'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v5
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install system dependencies (Ubuntu)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential gfortran libopenblas-dev liblapack-dev
        # Note: We intentionally DO NOT install libeigen3-dev to test automatic download
    
    - name: Install system dependencies (macOS)
      if: runner.os == 'macOS'
      run: |
        # Install Homebrew LLVM and OpenMP
        brew install llvm libomp
        # Set up environment to use Homebrew LLVM
        echo "CC=$(brew --prefix llvm)/bin/clang" >> $GITHUB_ENV
        echo "CXX=$(brew --prefix llvm)/bin/clang++" >> $GITHUB_ENV
    
    - name: Install system dependencies (Windows)
      if: runner.os == 'Windows'
      run: |
        # Windows uses MSVC by default, which works fine for our build
        # We intentionally DO NOT install Eigen3 to test automatic download
        echo "Using default Windows build tools (MSVC)"
    
    - name: Cache pip packages
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-pip-${{ matrix.python-version }}-
    
    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build wheel setuptools
    
    - name: Test automatic Eigen3 download and build
      run: |
        echo "Testing automatic Eigen3 download during build..."
        python -m build --wheel
        echo "Build successful! Checking wheel contents..."
      
    - name: List built wheels
      shell: bash
      run: |
        echo "Built wheels:"
        if [ -d "dist" ]; then
          find dist -name "*.whl" -exec basename {} \; 2>/dev/null || python -c "import os; [print(f) for f in os.listdir('dist') if f.endswith('.whl')]"
        else
          echo "No dist directory found"
        fi
    
    - name: Install BLASter from wheel
      shell: bash
      run: |
        # Install the built wheel
        python -m pip install --upgrade pip
        pip install "numpy>=1.20" cysignals matplotlib
        pip install --no-index --find-links dist/ blaster-python
    
    - name: Test basic functionality
      run: |
        python -c "
        import blaster
        import numpy as np
        print('[OK] BLASter imported successfully')
        
        # Test basic LLL reduction
        basis = np.array([[10, 2, 3], [1, 12, 4], [2, 1, 15]])
        result = blaster.lll_reduce(basis, verbose=False)
        
        print(f'[OK] LLL reduction works: RHF = {result.rhf:.6f}')
        print(f'[OK] Basis shape: {result.reduced_basis.shape}')
        print(f'[OK] Transformation verified: {result.verify_transformation()}')
        
        # Test BKZ reduction
        bkz_result = blaster.bkz_reduce(basis, beta=3, verbose=False)
        print(f'[OK] BKZ reduction works: RHF = {bkz_result.rhf:.6f}')
        
        # Test convenience functions
        reduced = blaster.lll(basis, verbose=False)
        print(f'[OK] Convenience function works: shape = {reduced.shape}')
        
        print('SUCCESS: All functionality tests passed!')
        "
    
    - name: Test console script
      run: |
        blaster --help
        echo "[OK] Console script works"
    
    - name: Run demo script
      run: |
        python examples/demo.py
        echo "[OK] Demo script completed successfully"
    
    - name: Upload wheel artifacts
      uses: actions/upload-artifact@v4
      if: matrix.python-version == '3.11' && matrix.os == 'ubuntu-latest'
      with:
        name: wheels-${{ matrix.os }}-py${{ matrix.python-version }}
        path: dist/*.whl
        retention-days: 7

  test-source-distribution:
    name: Test Source Distribution Build
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip build
    
    - name: Build source distribution
      run: |
        python -m build --sdist
        echo "Source distribution built successfully"
        ls -la dist/
    
    - name: Test installation from sdist
      run: |
        # Install from source distribution to test complete build process
        pip install dist/*.tar.gz
        
        # Test that it works
        python -c "
        import blaster
        import numpy as np
        basis = np.array([[1, 2], [2, 3]])
        result = blaster.lll_reduce(basis, verbose=False)
        print(f'[OK] Installation from sdist works: RHF = {result.rhf:.6f}')
        "
    
    - name: Upload sdist artifact
      uses: actions/upload-artifact@v4
      with:
        name: source-distribution
        path: dist/*.tar.gz
        retention-days: 7

  test-eigen3-scenarios:
    name: Test Different Eigen3 Scenarios
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        scenario: ['no-eigen', 'system-eigen', 'conda-eigen']
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Setup Eigen3 scenario - ${{ matrix.scenario }}
      run: |
        case "${{ matrix.scenario }}" in
          "no-eigen")
            echo "Testing with no system Eigen3 (should download automatically)"
            ;;
          "system-eigen")
            echo "Testing with system Eigen3 (should use existing)"
            sudo apt-get update
            sudo apt-get install -y libeigen3-dev
            ;;
          "conda-eigen")
            echo "Testing with conda Eigen3"
            # Install miniconda
            wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
            bash Miniconda3-latest-Linux-x86_64.sh -b -p $HOME/miniconda
            export PATH="$HOME/miniconda/bin:$PATH"
            conda install -y eigen
            echo "CONDA_PREFIX=$HOME/miniconda" >> $GITHUB_ENV
            ;;
        esac
    
    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip build
    
    - name: Test build with ${{ matrix.scenario }}
      run: |
        echo "Building with scenario: ${{ matrix.scenario }}"
        python -m build --wheel
        python -m pip install --upgrade pip
        pip install "numpy>=1.20" cysignals matplotlib
        pip install --no-index --find-links dist/ blaster-python
        
        # Verify it works
        python -c "
        import blaster
        import numpy as np
        basis = np.array([[5, 1], [1, 5]])
        result = blaster.lll_reduce(basis, verbose=False)
        print(f'[OK] Scenario ${{ matrix.scenario }} works: RHF = {result.rhf:.6f}')
        "

  lint-check:
    name: Code Linting with Ruff
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install ruff
      run: |
        python -m pip install --upgrade pip
        pip install ruff
    
    - name: Run ruff linter
      run: |
        echo "Running ruff linter..."
        ruff check src/ examples/ --output-format=github
    
    - name: Run ruff formatter check
      run: |
        echo "Checking code formatting with ruff..."
        ruff format --check src/ examples/

  performance-test:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install BLASter
      run: |
        python -m pip install --upgrade pip build
        python -m build --wheel
        pip install "numpy>=1.20" cysignals matplotlib
        pip install --no-index --find-links dist/ blaster-python
    
    - name: Run performance benchmarks
      run: |
        python -c "
        import blaster
        import numpy as np
        import time
        
        print('[PERF] Performance Benchmarks')
        print('=' * 40)
        
        # Small lattice benchmark
        basis = np.random.randint(-10, 11, size=(8, 8))
        start = time.time()
        result = blaster.lll_reduce(basis, verbose=False)
        elapsed = time.time() - start
        print(f'8x8 LLL: {elapsed:.3f}s, RHF: {result.rhf:.6f}')
        
        # Medium lattice benchmark  
        basis = np.random.randint(-10, 11, size=(16, 16))
        start = time.time()
        result = blaster.lll_reduce(basis, verbose=False)
        elapsed = time.time() - start
        print(f'16x16 LLL: {elapsed:.3f}s, RHF: {result.rhf:.6f}')
        
        print('[OK] Performance tests completed')
        "

  documentation:
    name: Documentation Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Check documentation files
      run: |
        echo "Checking documentation completeness..."
        
        # Check that key documentation files exist
        test -f README.md || (echo "[ERROR] Missing README.md" && exit 1)
        test -f INTERFACE_README.md || (echo "[ERROR] Missing INTERFACE_README.md" && exit 1)
        test -f examples/demo.py || (echo "[ERROR] Missing examples/demo.py" && exit 1)
        
        # Check that README mentions the new features
        grep -q "automatic" README.md || (echo "[WARNING] README should mention automatic Eigen3" && exit 1)
        grep -q "pip install" README.md || (echo "[WARNING] README should mention pip install" && exit 1)
        
        echo "[OK] Documentation checks passed"
